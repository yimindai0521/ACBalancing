<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>package_intro • ACBalancing</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="package_intro">
<meta property="og:description" content="ACBalancing">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ACBalancing</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/package_intro.html">package_intro</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>package_intro</h1>
            
      
      
      <div class="hidden name"><code>package_intro.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ACBalancing</span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>MBalance</code> implements the Mahalanobis balancing method
for estimating ATE and ATT or ATC on observational data. Our method has
good performance (low bias, small balancing diagnostics) in “Bad
Overlap” situations (e.g., <span class="math inline">\(E\{Pr(T = 1 \mid
X)\}\)</span> closes to 0 or 1, <span class="math inline">\(E\{ X \mid T
= 1\}\)</span> and <span class="math inline">\(E\{ X \mid T =
0\}\)</span> are significantly different, high-dimensional
covariate).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Install the "MBalance" package from github.</span>
<span class="co"># if (!require(c("devtools","WeightIt","MASS","cobalt"))){</span>
<span class="co">#     install.packages(c("devtools","WeightIt","MASS","cobalt"))</span>
<span class="co"># }</span>
<span class="co"># devtools::install_github("yimindai0521/MBalance")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MBalance</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'MBalance'</span>
<span class="co">#&gt; The following objects are masked from 'package:ACBalancing':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Cholesky, MB, si.data</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/WeightIt/" class="external-link">WeightIt</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">sbw</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: Matrix</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'Matrix'</span>
<span class="co">#&gt; The following object is masked from 'package:MBalance':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Cholesky</span>
<span class="co">#&gt; The following object is masked from 'package:ACBalancing':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Cholesky</span>
<span class="co">#&gt; Loading required package: quadprog</span>
<span class="co">#&gt; Loading required package: slam</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/cobalt/" class="external-link">cobalt</a></span><span class="op">)</span>
<span class="co">#&gt;  cobalt (Version 4.3.2, Build Date: 2022-01-19)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="implementation-of-other-covariate-balancing-methods">Implementation of other covariate balancing methods<a class="anchor" aria-label="anchor" href="#implementation-of-other-covariate-balancing-methods"></a>
</h2>
<p>We provide function <code>covbal</code> (using R package
<code>Weightit</code> <span class="citation">Greifer
(2022b)</span>),<code>sbwbal</code>(using R package <code>sbw</code>
<span class="citation">Zubizarreta et al. (2021)</span>) to implement
Mahalanobis balancing method and other covariate balancing methods,
including inverse probability weighting (ps) in <span class="citation">Rosenbaum (1987)</span>, entropy balancing (ebal) in
<span class="citation">Hainmueller (2012)</span>, covariate balancing
propensity score (cbps) in <span class="citation">Imai and Ratkovic
(2014)</span>, energy balancing (energy) in <span class="citation">Huling and Mak (2020)</span>, minimal dispersion
approximate balancing weights (sbw) in <span class="citation">Wang and
Zubizarreta (2020)</span>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">covbal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">Tr</span>, <span class="va">Y</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Tr</span><span class="op">)</span><span class="op">)</span>
  <span class="va">sample.size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="va">dimension</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>

  <span class="va">character</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data.matrix</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">character</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">myformula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="fl">1</span> <span class="op">+</span> <span class="va">dimension</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">" ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

  <span class="va">ps.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span><span class="va">myformula</span>, data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, method <span class="op">=</span> <span class="st">"ps"</span><span class="op">)</span><span class="op">$</span><span class="va">weights</span>
  <span class="va">ps.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">ps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">ps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>

  <span class="va">ebal.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span><span class="va">myformula</span>, data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, method <span class="op">=</span> <span class="st">"ebal"</span><span class="op">)</span><span class="op">$</span><span class="va">weights</span>
  <span class="va">ebal.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">ebal.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ebal.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">ebal.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ebal.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>
  <span class="va">ebal.weight</span><span class="op">[</span><span class="va">ebal.weight</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>

  <span class="va">cbps.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span><span class="va">myformula</span>, data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, method <span class="op">=</span> <span class="st">"cbps"</span>, over <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">weights</span>
  <span class="va">cbps.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cbps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cbps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cbps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cbps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>

  <span class="va">energy.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span><span class="va">myformula</span>, data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, method <span class="op">=</span> <span class="st">"energy"</span><span class="op">)</span><span class="op">$</span><span class="va">weights</span>
  <span class="va">energy.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">energy.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">energy.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">energy.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">energy.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>

  <span class="va">MB.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="va">MB1.result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">sample.size</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span>
  <span class="va">MB2.result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">sample.size</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span>
  <span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="va">MB1.result</span><span class="op">$</span><span class="va">weight</span>
  <span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">MB2.result</span><span class="op">$</span><span class="va">weight</span>
  <span class="va">MB.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>


  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="va">ps.weight</span>, ebal <span class="op">=</span> <span class="va">ebal.weight</span>, cbps <span class="op">=</span> <span class="va">cbps.weight</span>, energy <span class="op">=</span> <span class="va">energy.weight</span>, MB <span class="op">=</span> <span class="va">MB.weight</span><span class="op">)</span>, ate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="va">ps.ate</span>, ebal <span class="op">=</span> <span class="va">ebal.ate</span>, cbps <span class="op">=</span> <span class="va">cbps.ate</span>, energy <span class="op">=</span> <span class="va">energy.ate</span>, MB <span class="op">=</span> <span class="va">MB.ate</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">sbwbal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">Tr</span>, <span class="va">Y</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Tr</span><span class="op">)</span>, <span class="va">Y</span><span class="op">)</span>
  <span class="va">dimension</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
  <span class="va">bal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">bal</span><span class="op">$</span><span class="va">bal_gri</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-04</span>, <span class="fl">0.001</span>, <span class="fl">0.002</span>, <span class="fl">0.005</span>, <span class="fl">0.01</span>, <span class="fl">0.02</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="va">character</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data.matrix</span><span class="op">)</span>
  <span class="va">bal</span><span class="op">$</span><span class="va">bal_cov</span> <span class="op">&lt;-</span> <span class="va">character</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">]</span>
  <span class="va">sbw.result</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
  <span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">sbw.result</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">sbw.result</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="va">sbw.result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sbw/man/sbw.html" class="external-link">sbw</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">data.matrix</span>, ind <span class="op">=</span> <span class="va">character</span><span class="op">[</span><span class="fl">1</span> <span class="op">+</span> <span class="va">dimension</span><span class="op">]</span>, bal <span class="op">=</span> <span class="va">bal</span>, out <span class="op">=</span> <span class="va">character</span><span class="op">[</span><span class="fl">2</span> <span class="op">+</span> <span class="va">dimension</span><span class="op">]</span>, par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>par_est <span class="op">=</span> <span class="st">"ate"</span><span class="op">)</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">skip_to_next</span> <span class="op">&lt;&lt;-</span> <span class="cn">FALSE</span>
    <span class="op">}</span><span class="op">)</span>
    <span class="va">bal</span><span class="op">$</span><span class="va">bal_gri</span> <span class="op">&lt;-</span> <span class="va">bal</span><span class="op">$</span><span class="va">bal_gri</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>
  <span class="op">}</span>
  <span class="va">sbw.weight</span> <span class="op">&lt;-</span> <span class="va">sbw.result</span><span class="op">$</span><span class="va">dat_weights</span><span class="op">$</span><span class="va">sbw_weights</span>
  <span class="va">sbw.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sbw.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sbw.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sbw.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sbw.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="va">sbw.weight</span>, ate <span class="op">=</span> <span class="va">sbw.ate</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generating-data">Generating data<a class="anchor" aria-label="anchor" href="#generating-data"></a>
</h2>
<p>We consider three different simulation settings. The first simulation
will be Scenario C in our paper. We first generate treatment indicator
<span class="math inline">\(T\)</span> from <span class="math inline">\(Bernoulli(0.5)\)</span> for each observation. The
observed covariates depend on treatment assignment. If <span class="math inline">\(T = 1\)</span>, then <span class="math inline">\(X
\sim N(1, \Sigma)\)</span> where the jth row and kth column of <span class="math inline">\(\Sigma\)</span> is <span class="math inline">\(\rho^{|j−k|}\)</span> and we set <span class="math inline">\(\rho = 1/2\)</span>, otherwise, <span class="math inline">\(X \sim N(0,I)\)</span>. The observed outcome is
generated from: <span class="math inline">\(Y(T) = (1 - T)(X_1 + ... +
X_6) + T(X_1 + ... + X_6) / 2\)</span>. In this setting, <span class="math inline">\(E\{ X \mid T = 1\}\)</span> and <span class="math inline">\(E\{ X \mid T = 0\}\)</span> are significantly
different and thus it’s a “Bad Overlap” situation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">si.data.bad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dimension</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">sample.size</span> <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">covmatrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span>, <span class="va">dimension</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">covmatrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">^</span><span class="op">{</span>
        <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">i</span> <span class="op">!=</span> <span class="va">j</span><span class="op">)</span>
      <span class="op">}</span>
    <span class="op">}</span>
  <span class="op">}</span>
  <span class="va">treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">sample.size</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>
  <span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">sample.size</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="va">covmatrix</span><span class="op">)</span>
  <span class="va">z0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">sample.size</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">treat</span> <span class="op">*</span> <span class="va">z1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="va">z0</span>
  <span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample.size</span><span class="op">)</span>
  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">+</span> <span class="va">noise</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">treat</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The second simulation setting corresponds Scenario D to our paper.
The observed covariates are simulated by <span class="math inline">\(X
\sim N(1,I)\)</span>. The treatment indicator is simulated from <span class="math inline">\(T ∼ Bernoulli(\pi(X))\)</span> with <span class="math inline">\(π(X) = 1/(1+19 \exp(X_1+···+X_{10}−10))\)</span>.
The outcome is simulated from <span class="math inline">\(Y =
(1+T)(X_1+···+X_{10}) + \epsilon\)</span>, where <span class="math inline">\(\epsilon \sim N(0,1)\)</span>. In this setting,
<span class="math inline">\(E\{Pr(T = 1 \mid X)\}\)</span> closes to 0
or 1 and thus it’s a “Bad Overlap” situation.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">si.data.badover</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dimension</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">sample.size</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample.size</span> <span class="op">*</span> <span class="va">dimension</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, nrow <span class="op">=</span> <span class="va">sample.size</span>, ncol <span class="op">=</span> <span class="va">dimension</span><span class="op">)</span>
  <span class="va">ps</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">19</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
  <span class="va">treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sample.size</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">treat</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">ps</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample.size</span><span class="op">)</span>
  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">+</span> <span class="va">noise</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">treat</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="mb-estimating-average-treatment-effect">
<code>MB</code>: estimating average treatment effect<a class="anchor" aria-label="anchor" href="#mb-estimating-average-treatment-effect"></a>
</h2>
<p>We will use function in R package <span class="citation">Greifer
(2022a)</span> to plot ASMD to compare the performance for different
covariate balancing methods.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## generating data from Scenario C</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1999</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">si.data.bad</span><span class="op">(</span><span class="op">)</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">covbal</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, <span class="va">data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span>
<span class="co">#&gt; Warning: Some weights were estimated as NA, which means a value was impossible</span>
<span class="co">#&gt; to compute (e.g., Inf). Check for extreme values of the treatment or covariates</span>
<span class="co">#&gt; and try removing them. Non-finite weights will be set to 0.</span>
<span class="co">#&gt; Warning: All weights are NA or 0 in treatment group '0'.</span>
<span class="va">sbw.re</span> <span class="op">&lt;-</span> <span class="fu">sbwbal</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, <span class="va">data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found.</span>

<span class="co">## plot ASMD</span>
<span class="va">dimension</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="va">data.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">treat</span><span class="op">)</span><span class="op">)</span>
<span class="va">character</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data.matrix</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">character</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">myformula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="fl">1</span> <span class="op">+</span> <span class="va">dimension</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">" ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/love.plot.html" class="external-link">love.plot</a></span><span class="op">(</span><span class="va">myformula</span>,
  data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>,
  stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mean.diffs"</span><span class="op">)</span>,
  weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    w1 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">MB</span>,
    w2 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">ps</span>,
    w3 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">ebal</span>,
    w4 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">cbps</span>,
    w5 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">energy</span>,
    w6 <span class="op">=</span> <span class="va">sbw.re</span><span class="op">$</span><span class="va">weight</span>
  <span class="op">)</span>,
  var.order <span class="op">=</span> <span class="st">"unadjusted"</span>,
  abs <span class="op">=</span> <span class="cn">TRUE</span>,
  line <span class="op">=</span> <span class="cn">TRUE</span>,
  thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span>,
  sample.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Unweighted"</span>, <span class="st">"MB"</span>, <span class="st">"PS"</span>, <span class="st">"ebal"</span>, <span class="st">"cbps"</span>, <span class="st">"energy"</span>, <span class="st">"sbw"</span><span class="op">)</span>,
  limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span>,
  wrap <span class="op">=</span> <span class="fl">20</span>,
  position <span class="op">=</span> <span class="st">"top"</span>
<span class="op">)</span></code></pre></div>
<p><img src="package_intro_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">## generating data from Scenario D</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">si.data.badover</span><span class="op">(</span><span class="op">)</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">covbal</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, <span class="va">data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span>
<span class="co">#&gt; Warning: Some extreme weights were generated. Examine them with summary() and</span>
<span class="co">#&gt; maybe trim them with trim().</span>
<span class="co">#&gt; Warning: Some extreme weights were generated. Examine them with summary() and</span>
<span class="co">#&gt; maybe trim them with trim().</span>
<span class="va">sbw.re</span> <span class="op">&lt;-</span> <span class="fu">sbwbal</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, <span class="va">data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found. </span>
<span class="co">#&gt;   quadprog optimizer is opening... </span>
<span class="co">#&gt;   Finding the optimal weights... </span>
<span class="co">#&gt;   Optimal weights found.</span>

<span class="co">## plot ASMD</span>
<span class="va">dimension</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="va">data.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">treat</span><span class="op">)</span><span class="op">)</span>
<span class="va">character</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data.matrix</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">character</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">myformula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="fl">1</span> <span class="op">+</span> <span class="va">dimension</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">" ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/love.plot.html" class="external-link">love.plot</a></span><span class="op">(</span><span class="va">myformula</span>,
  data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>,
  stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mean.diffs"</span><span class="op">)</span>,
  weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    w1 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">MB</span>,
    w2 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">ps</span>,
    w3 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">ebal</span>,
    w4 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">cbps</span>,
    w5 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">energy</span>,
    w6 <span class="op">=</span> <span class="va">sbw.re</span><span class="op">$</span><span class="va">weight</span>
  <span class="op">)</span>,
  var.order <span class="op">=</span> <span class="st">"unadjusted"</span>,
  abs <span class="op">=</span> <span class="cn">TRUE</span>,
  line <span class="op">=</span> <span class="cn">TRUE</span>,
  thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span>,
  sample.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Unweighted"</span>, <span class="st">"MB"</span>, <span class="st">"PS"</span>, <span class="st">"ebal"</span>, <span class="st">"cbps"</span>, <span class="st">"energy"</span>, <span class="st">"sbw"</span><span class="op">)</span>,
  limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
  wrap <span class="op">=</span> <span class="fl">20</span>,
  position <span class="op">=</span> <span class="st">"top"</span>
<span class="op">)</span></code></pre></div>
<p><img src="package_intro_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<p>We can find that ASMD of MB is significantly lower than other
covariate balancing methods.</p>
<p>We repeat 200 times.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mainf1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">iteration</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">result1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">iteration</span>, <span class="fl">5</span><span class="op">)</span>
  <span class="va">result2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">iteration</span>, <span class="fl">5</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">iteration</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">data1</span> <span class="op">&lt;-</span> <span class="fu">si.data.bad</span><span class="op">(</span><span class="op">)</span>
    <span class="va">data2</span> <span class="op">&lt;-</span> <span class="fu">si.data.badover</span><span class="op">(</span><span class="op">)</span>
    <span class="va">result1</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">covbal</span><span class="op">(</span><span class="va">data1</span><span class="op">$</span><span class="va">X</span>, <span class="va">data1</span><span class="op">$</span><span class="va">treat</span>, <span class="va">data1</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">$</span><span class="va">ate</span>
    <span class="va">result2</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">covbal</span><span class="op">(</span><span class="va">data2</span><span class="op">$</span><span class="va">X</span>, <span class="va">data2</span><span class="op">$</span><span class="va">treat</span>, <span class="va">data2</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">$</span><span class="va">ate</span>
  <span class="op">}</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bad <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ps_bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result1</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">5</span>, ebal_bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result1</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">5</span>, cbps_bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result1</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">5</span>, energy_bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result1</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">5</span>, MB_bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result1</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">5</span><span class="op">)</span>, badover <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ps_bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result2</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span>, ebal_bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span>, cbps_bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result2</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span>, energy_bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result2</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span>, MB_bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result2</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0521</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>warn <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>
<span class="fu">mainf1</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt; $bad</span>
<span class="co">#&gt; $bad$ps_bias</span>
<span class="co">#&gt; [1] -5.82584</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $bad$ebal_bias</span>
<span class="co">#&gt; [1] NaN</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $bad$cbps_bias</span>
<span class="co">#&gt; [1] -2.800645</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $bad$energy_bias</span>
<span class="co">#&gt; [1] 0.8981792</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $bad$MB_bias</span>
<span class="co">#&gt; [1] 0.219754</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $badover</span>
<span class="co">#&gt; $badover$ps_bias</span>
<span class="co">#&gt; [1] -1.848594</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $badover$ebal_bias</span>
<span class="co">#&gt; [1] NaN</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $badover$cbps_bias</span>
<span class="co">#&gt; [1] -0.8220655</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $badover$energy_bias</span>
<span class="co">#&gt; [1] -1.695121</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $badover$MB_bias</span>
<span class="co">#&gt; [1] -0.245012</span></code></pre></div>
<p>We can find that our method has lower bias than other methods because
our purposed method has significantly lower imbalance and thus greatly
outperforms other methods.</p>
</div>
<div class="section level2">
<h2 id="interpretation">Interpretation<a class="anchor" aria-label="anchor" href="#interpretation"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## generating data</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MBalance</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0521</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/si.data.html" class="external-link">si.data</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">result1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span>
<span class="va">result2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span>

<span class="co">## (\beta_1-\beta_0)</span>
<span class="va">result1</span><span class="op">$</span><span class="va">parameter</span> <span class="op">-</span> <span class="va">result2</span><span class="op">$</span><span class="va">parameter</span>
<span class="co">#&gt;  [1] -1.0750115 -1.0703083 -1.0236292 -0.9994522 -0.8311325 -0.9487348</span>
<span class="co">#&gt;  [7] -1.1879800 -0.9607046 -0.7351650 -1.0633780</span></code></pre></div>
<p>In function <code>si.data</code>, we generate the treatment
assignment from the logistic regression model: <span class="math inline">\(Pr(T = 1 | X) = 1/ (1 + \exp(X_1 + ... +
X_{10}))\)</span>. The ratio <span class="math inline">\(Pr(T = 1 | X) /
Pr(T = 0 | X) \text{ is } \exp(- X_1 - ... - X_{10})\)</span>.
Similarly, Mahalanobis balancing assume the propensity score model is
<span class="math inline">\(Pr(T = a | X) =
\exp(\beta_a^{\top}X)\)</span>, then the ratio is <span class="math inline">\(Pr(T = 1 | X) / Pr(T = 0 | X) will be
\exp((\beta_1-\beta_0)^{\top}X)\)</span>. In simulation, our result
<code>result1$parameter - result2$parameter = -(1.08,1.07 1.02,1.00,0.83,0.95,1.19,0.96,0.74,1.06)</code>
approximates to the true value <span class="math inline">\(-(1,1,1,1,1,1,1,1,1,1,1,1)\)</span>.</p>
Our method can be applied to multiple groups. We generate the observed
covariate <span class="math inline">\(X = (X_1, ..., X_10)\)</span>,
then the assignment will be simulated from $$
<span class="math display">\[\begin{aligned}
Pr(T = 1 \mid X) &amp; = \frac{1}{1 + \exp(4X_1 + ... + 4X_5) +
\exp(2X_6 + ... + 2X_{10})} \\
Pr(T = 2 \mid X) &amp; = \frac{\exp(4X_1 + ... + 4X_5)}{1 + \exp(4X_1 +
... + 4X_5) + \exp(2X_6 + ... + 2X_{10})} \\
Pr(T = 3 \mid X) &amp; = \frac{\exp(2X_6 + ... + 2X_{10})}{1 + \exp(4X_1
+ ... + 4X_5) + \exp(2X_6 + ... + 2X_{10})}
\end{aligned}\]</span>
<p>$$</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">si.data.mult</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sample.size</span> <span class="op">=</span> <span class="fl">500</span>, <span class="va">dimension</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample.size</span> <span class="op">*</span> <span class="va">dimension</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">sample.size</span>, ncol <span class="op">=</span> <span class="va">dimension</span><span class="op">)</span>
  <span class="va">ps1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="va">ps2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>
  <span class="va">ps3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>
  <span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">ps1</span> <span class="op">/</span> <span class="op">(</span><span class="va">ps1</span> <span class="op">+</span> <span class="va">ps2</span> <span class="op">+</span> <span class="va">ps3</span><span class="op">)</span>, <span class="va">ps2</span> <span class="op">/</span> <span class="op">(</span><span class="va">ps1</span> <span class="op">+</span> <span class="va">ps2</span> <span class="op">+</span> <span class="va">ps3</span><span class="op">)</span>, <span class="va">ps3</span> <span class="op">/</span> <span class="op">(</span><span class="va">ps1</span> <span class="op">+</span> <span class="va">ps2</span> <span class="op">+</span> <span class="va">ps3</span><span class="op">)</span><span class="op">)</span>
  <span class="va">uniform</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">sample.size</span><span class="op">)</span>
  <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">ps</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">uniform</span>, <span class="va">ps</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">ps</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">uniform</span><span class="op">)</span>
  <span class="va">Tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">index</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Tr <span class="op">=</span> <span class="va">Tr</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Then we generate data and study our method in multiple group:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1999</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">si.data.mult</span><span class="op">(</span><span class="op">)</span>
<span class="va">result1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, delta.space <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">result2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">2</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, delta.space <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">result3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">3</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, delta.space <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="va">result2</span><span class="op">$</span><span class="va">parameter</span> <span class="op">-</span> <span class="va">result1</span><span class="op">$</span><span class="va">parameter</span>
<span class="co">#&gt;  [1]  4.00425288  4.30377156  3.68467453  4.58550503  3.44791219 -0.06025856</span>
<span class="co">#&gt;  [7] -0.52248440 -0.66019836 -0.09789295 -0.99479415</span>
<span class="va">result3</span><span class="op">$</span><span class="va">parameter</span> <span class="op">-</span> <span class="va">result1</span><span class="op">$</span><span class="va">parameter</span>
<span class="co">#&gt;  [1] -0.1860177  0.5086572 -0.1017728  0.3984856 -0.5865772  2.2900711</span>
<span class="co">#&gt;  [7]  2.4342730  1.3492398  2.1544179  2.2255653</span></code></pre></div>
<p>We can find that our result is close to the true parameter in the
propensity score model.</p>
<p>The true ratio is <span class="math inline">\(Pr(T = 2 | X) / Pr(T =
1 | X) = \exp(4X_1 + ... + 4X_5)\)</span>, <span class="math inline">\(Pr(T = 3 | X) / Pr(T = 1 | X) = \exp(2X_6 + ... +
2X_{10})\)</span>. In simulation, our result
<code>result2$parameter - result1$parameter</code> <span class="math inline">\(\approx = (4,4,4,4,4,0,0,0,0,0)\)</span> and
<code>result3$parameter - result1$parameter</code> <span class="math inline">\(\approx = (0,0,0,0,0,2,2,2,2,2)\)</span>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1999</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">si.data.mult</span><span class="op">(</span><span class="op">)</span>
<span class="va">result1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, delta.space <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">result2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">2</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, delta.space <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">result3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">3</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, delta.space <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="va">result2</span><span class="op">$</span><span class="va">parameter</span> <span class="op">-</span> <span class="va">result1</span><span class="op">$</span><span class="va">parameter</span>
<span class="co">#&gt;  [1]  4.00425288  4.30377156  3.68467453  4.58550503  3.44791219 -0.06025856</span>
<span class="co">#&gt;  [7] -0.52248440 -0.66019836 -0.09789295 -0.99479415</span>
<span class="va">result3</span><span class="op">$</span><span class="va">parameter</span> <span class="op">-</span> <span class="va">result1</span><span class="op">$</span><span class="va">parameter</span>
<span class="co">#&gt;  [1] -0.1860177  0.5086572 -0.1017728  0.3984856 -0.5865772  2.2900711</span>
<span class="co">#&gt;  [7]  2.4342730  1.3492398  2.1544179  2.2255653</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="balancing-covariate-in-finite-sample">Balancing Covariate in Finite Sample<a class="anchor" aria-label="anchor" href="#balancing-covariate-in-finite-sample"></a>
</h2>
<p>We discuss our method in ``Bad Overlap” setting. We generate
treatment indicator <span class="math inline">\(T\)</span> from <span class="math inline">\(Bernoulli(0.5)\)</span> for each observation. The
observed covariates depend on treatment assignment. If <span class="math inline">\(T = 1\)</span>, then <span class="math inline">\(X
\sim N(2, \Sigma)\)</span> where the jth row and kth column of <span class="math inline">\(\Sigma\)</span> is <span class="math inline">\(\rho^{|j−k|}\)</span> and we set <span class="math inline">\(\rho = 1/2\)</span>, otherwise, <span class="math inline">\(X \sim N(0,I)\)</span>. The observed outcome is
generated from: <span class="math inline">\(Y(T) = (1 - T)(X_1 + ... +
X_{10}) + T(X_1 + ... + X_{10}) / 2\)</span>. In this setting, <span class="math inline">\(E\{ X \mid T = 1\}\)</span> and <span class="math inline">\(E\{ X \mid T = 0\}\)</span> are significantly
different and thus it’s a very “Bad Overlap” situation.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span>
<span class="va">si.data.imbal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sample.size</span> <span class="op">=</span> <span class="fl">500</span>, <span class="va">dimension</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">covmatrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span>, <span class="va">dimension</span><span class="op">)</span>
  <span class="va">treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">sample.size</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>
  <span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">sample.size</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span>
  <span class="va">z0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">sample.size</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">treat</span> <span class="op">*</span> <span class="va">z1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="va">z0</span>
  <span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">sample.size</span><span class="op">)</span>
  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">+</span> <span class="va">noise</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">treat</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## sample.size = 500</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1999</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">si.data.imbal</span><span class="op">(</span>sample.size <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt;           [,1]</span>
<span class="co">#&gt; [1,] 0.3587975</span>
<span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt;          [,1]</span>
<span class="co">#&gt; [1,] 2.345359</span>

<span class="co">## sample.size = 5000</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">si.data.imbal</span><span class="op">(</span>sample.size <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt;            [,1]</span>
<span class="co">#&gt; [1,] 0.00401846</span>
<span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt;            [,1]</span>
<span class="co">#&gt; [1,] 0.04828437</span>

<span class="co">## sample.size = 50000</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">si.data.imbal</span><span class="op">(</span>sample.size <span class="op">=</span> <span class="fl">50000</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt;              [,1]</span>
<span class="co">#&gt; [1,] 2.226678e-09</span>
<span class="fu"><a href="https://rdrr.io/pkg/MBalance/man/MB.html" class="external-link">MB</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt;              [,1]</span>
<span class="co">#&gt; [1,] 4.817671e-10</span></code></pre></div>
<p>When the sample size = 500, we find that GMIM is quite large and thus
we not recommend to use MB method to estimate average treatment effect.
MB method may not approximately balances covariate in finite sample in
very ``Bad Overlap” setting. However, when the sample size = 5000, we
find that GMIM is relatively small. Therefore, we can use the result
that produced by MB method. Hence, our method has better performance
when the sample size is large.</p>
</div>
<div class="section level2">
<h2 id="bad-overlap-in-propensity-score">Bad Overlap in Propensity score<a class="anchor" aria-label="anchor" href="#bad-overlap-in-propensity-score"></a>
</h2>
<p>We revisit the second simulation setting corresponds Scenario D to
our paper. The observed covariates are simulated by <span class="math inline">\(X \sim N(1,I)\)</span>. The treatment indicator is
simulated from <span class="math inline">\(T ∼
Bernoulli(\pi(X))\)</span> with <span class="math inline">\(π(X) =
1/(1+19 \exp(X_1+···+X_{10}−10))\)</span>. The outcome is simulated from
<span class="math inline">\(Y = (1+T)(X_1+···+X_{10}) +
\epsilon\)</span>, where <span class="math inline">\(\epsilon \sim
N(0,1)\)</span>. In this setting, <span class="math inline">\(E\{Pr(T =
1 \mid X)\}\)</span> closes to 0 or 1 and thus it’s a “Bad Overlap”
situation.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">si.data.badover</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dimension</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">sample.size</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample.size</span> <span class="op">*</span> <span class="va">dimension</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, nrow <span class="op">=</span> <span class="va">sample.size</span>, ncol <span class="op">=</span> <span class="va">dimension</span><span class="op">)</span>
  <span class="va">ps</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">19</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
  <span class="va">treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sample.size</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">treat</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">ps</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample.size</span><span class="op">)</span>
  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">+</span> <span class="va">noise</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">treat</span><span class="op">)</span>, Y <span class="op">=</span> <span class="va">Y</span>, ps <span class="op">=</span> <span class="va">ps</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Greifer2022cobalt" class="csl-entry">
Greifer, Noah. 2022a. <em>Cobalt: Covariate Balance Tables and
Plots</em>.
</div>
<div id="ref-Gerifer2022Weightit" class="csl-entry">
———. 2022b. <em>WeightIt: Weighting for Covariate Balance in
Observational Studies</em>.
</div>
<div id="ref-hainmueller2012entropy" class="csl-entry">
Hainmueller, Jens. 2012. <span>“Entropy Balancing for Causal Effects: A
Multivariate Reweighting Method to Produce Balanced Samples in
Observational Studies.”</span> <em>Political Analysis</em> 20 (1):
25–46.
</div>
<div id="ref-huling2020energy" class="csl-entry">
Huling, Jared D, and Simon Mak. 2020. <span>“Energy Balancing of
Covariate Distributions.”</span> <em>arXiv Preprint
arXiv:2004.13962</em>.
</div>
<div id="ref-imai2014covariate" class="csl-entry">
Imai, Kosuke, and Marc Ratkovic. 2014. <span>“Covariate Balancing
Propensity Score.”</span> <em>Journal of the Royal Statistical Society:
Series B (Statistical Methodology)</em> 76 (1): 243–63.
</div>
<div id="ref-rosenbaum1987model" class="csl-entry">
Rosenbaum, Paul R. 1987. <span>“Model-Based Direct Adjustment.”</span>
<em>Journal of the American Statistical Association</em> 82 (398):
387–94.
</div>
<div id="ref-wang2020minimal" class="csl-entry">
Wang, Yixin, and Jose R Zubizarreta. 2020. <span>“Minimal Dispersion
Approximately Balancing Weights: Asymptotic Properties and Practical
Considerations.”</span> <em>Biometrika</em> 107 (1): 93–105.
</div>
<div id="ref-zubizarreta2021package" class="csl-entry">
Zubizarreta, Jose R, Yige Li, Kwangho Kim, Amine Allouah, and Noah
Greifer. 2021. <span>“Package <span>‘Sbw’</span>.”</span>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by The package maintainer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
