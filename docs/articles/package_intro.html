<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ACBalancing">
<title>A Brief Introduction to ACBalancing • ACBalancing</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="A Brief Introduction to ACBalancing">
<meta property="og:description" content="ACBalancing">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ACBalancing</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/package_intro.html">A Brief Introduction to ACBalancing</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>A Brief Introduction to ACBalancing</h1>
            
      
      
      <div class="d-none name"><code>package_intro.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ACBalancing</span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Consider a random sample of <span class="math inline">\(n\)</span>
individuals from a population.</p>
<p>Under the potential outcome framework (<span class="citation">Imbens
and Rubin (2015)</span>), we define a pair of potential outcomes <span class="math inline">\(\{Y(0), Y(1)\}\)</span> for each individual if
he/she were not treated or treated. The observed outcome is defined as
<span class="math inline">\(Y=(1-T) Y(0)+T Y(1)\)</span>.</p>
<p>The causal estimand of interest is the average treatment effect
(ATE), defined by <span class="math inline">\(\tau=E\{Y(1)-Y(0)\}=\mu_1-\mu_0\)</span>, where
<span class="math inline">\(\mu_j=E\{Y(j)\}, j=0,1\)</span>. The
proposed method can be changed to other causal estimands, e.g., the
average treatment effect on the treated (ATT). Under the strong
ignorability and overlap assumption <span class="citation">Imbens and
Rubin (2015)</span>, we can show that <span class="math inline">\(\mu_1=E\left\{\mu_1(X)\right\} =
E\left\{\frac{TY}{Pr(T = 1 \mid X)}\right\}\)</span> and <span class="math inline">\(\mu_0=E\left\{\mu_0(X)\right\} =
E\left\{\frac{(1-T)Y}{Pr(T = 0 \mid X)}\right\}\)</span>. Therefore, we
can estimate <span class="math inline">\(\mu_1\)</span> by estimating
propensity score <span class="math inline">\(Pr(T = 1 \mid
X)\)</span>.</p>
</div>
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>The goal for propensity score <span class="math inline">\(Pr(T = 1
\mid X)\)</span> is to balance the covariate, i.e, <span class="math display">\[E\left\{\frac{Tf(X)}{Pr(T = 1 \mid X)}\right\} =
E\left\{Tf(X)\right\}\]</span> where <span class="math inline">\(f(X)\)</span> is a function of <span class="math inline">\(X\)</span>.</p>
<p>In finite sample, the above formula is <span class="math display">\[
\sum_{i=1}^{n}\frac{T_if(X_i)}{\hat{Pr}(T = 1 \mid X_i)} =
\sum_{i=1}^{n}f(X_i)
\]</span> This motivates the covariate balancing method, and we directly
balance covariates instead of estimating the propensity score method.
The most well-known way is entropy balancing (<span class="citation">Hainmueller (2012)</span>) and stable weighting (<span class="citation">Zubizarreta (2015)</span>).</p>
<p><span class="math display">\[
\begin{array}{ll}
\underset{\boldsymbol{w}}{\operatorname{minimize}} &amp; \sum_{i=1}^{n}
T_if(w_i) \\
\text { subject to } &amp; \sum_{i=1}^{n}\boldsymbol{w_iT_i}
\boldsymbol{f(X)} = \sum_{i=1}^{n}f(X_i) / n\\
&amp; \mathbf{1}^{\top} \boldsymbol{w}=1, \\
&amp; \boldsymbol{w} \succeq 0,
\end{array}
\]</span> when <span class="math inline">\(f(w) = (w -
\frac{1}{n})^2\)</span>, it’s stable weighting and when <span class="math inline">\(f(w) = w\log(w)\)</span>, it’s entropy
balancing.</p>
<p>However, the exact balancing condition (<span class="math inline">\(\sum_{i=1}^{n}\boldsymbol{w_iT_i}
\boldsymbol{f(X)} = \sum_{i=1}^{n}f(X_i) / n\)</span>) may not hold in
finite sample. We call this a “Bad Overlap” situation when we cannot
find a solution <span class="math inline">\(w\)</span> to fulfill the
exact balancing condition. The “Bad Overlap” may happen when <span class="math inline">\(E\{Pr(T = 1 \mid X)\}\)</span> closes to 0 or 1,
<span class="math inline">\(E\{ X \mid T = 1\}\)</span> and <span class="math inline">\(E\{ X \mid T = 0\}\)</span> are significantly
different or the covariate is high-dimensional.</p>
<p>To alleviate the feasibility problem, <span class="citation">Wang and
Zubizarreta (2020)</span> proposed minimal dispersion approximately
balancing weights (MDABW) as a univariate approximate balancing
framework, which relaxes the balancing conditions by using inequality
constraints.</p>
<p><span class="math display">\[
\begin{array}{ll}
\underset{\boldsymbol{w}}{\operatorname{minimize}} &amp; \sum_{i=1}^{n}
T_if(w_i) \\
\text { subject to } &amp; |\sum_{i=1}^{n}\boldsymbol{w_iT_i}
\boldsymbol{f(X)} - \sum_{i=1}^{n}f(X_i) / n | \leq \delta_k, \quad k =
1,\cdots,d\\
&amp; \boldsymbol{w} \succeq 0,
\end{array}
\]</span></p>
<p>Other robust balancing methods may not suffer the feasibility
problem. For example, <span class="citation">Xu and Yang (2021)</span>
imposes ridge penalties in the optimization problem, and <span class="citation">Wong and Chan (2018)</span> minimizes covariate
imbalance directly by the regularized kernel regression method.</p>
<p>There is a potential issue with univariate approximate balancing. The
univariate balance does not guarantee overall balance, especially in the
case of a bad-overlap scenario, as shown in the numerical study. Another
issue is that there needs to be a moral way to select the threshold
parameters simultaneously. Extension of MDABW to handle the “Bad
Overlap” issue remains an open work.</p>
<p>Multivariate covariate balance can significantly help overcome the
limitations of univariate approximate balancing. Also, we provide a
single threshold parameter attached to the quadratic inequality
constraint in the Mahalanobis balancing method, which dramatically
handles the issue of multiple threshold parameters. In practice, the
Mahalanobis balancing method performs well (low bias, small balancing
diagnostics), especially in “Bad Overlap” situations.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Install the "ACBalancing" and other required package from github.</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/WeightIt/" class="external-link">WeightIt</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"WeightIt"</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"MASS"</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">CBPS</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"CBPS"</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; Loaded glmnet 4.1-3</span>
<span class="co">#&gt; CBPS: Covariate Balancing Propensity Score</span>
<span class="co">#&gt; Version: 0.23</span>
<span class="co">#&gt; Authors: Christian Fong [aut, cre],</span>
<span class="co">#&gt;   Marc Ratkovic [aut],</span>
<span class="co">#&gt;   Kosuke Imai [aut],</span>
<span class="co">#&gt;   Chad Hazlett [ctb],</span>
<span class="co">#&gt;   Xiaolin Yang [ctb],</span>
<span class="co">#&gt;   Sida Peng [ctb],</span>
<span class="co">#&gt;   Inbeom Lee [ctb]</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"microbenchmark"</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/cobalt/" class="external-link">cobalt</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"cobalt"</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt;  cobalt (Version 4.3.2, Build Date: 2022-01-19)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'cobalt'</span>
<span class="co">#&gt; The following object is masked from 'package:MatchIt':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     lalonde</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ggplot2"</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">ATE.ncb</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/remote-reexports.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"raymondkww/ATE.ncb"</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">ACBalancing</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/remote-reexports.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"yimindai0521/ACBalancing"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="get-started-and-interpretation-of-parameter">Get Started and Interpretation of Parameter<a class="anchor" aria-label="anchor" href="#get-started-and-interpretation-of-parameter"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0521</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/si.data.html">si.data</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">result1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span>
<span class="va">result2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span>, method <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span>
<span class="va">result3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/UB.html">UB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, opti.method <span class="op">=</span> <span class="st">"proximal"</span><span class="op">)</span>
<span class="va">result4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/UB.html">UB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, opti.method <span class="op">=</span> <span class="st">"proximal"</span><span class="op">)</span>
<span class="va">result5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/HRB.html">HRB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, second.moment <span class="op">=</span> <span class="cn">FALSE</span>, third.moment <span class="op">=</span> <span class="cn">FALSE</span>, interact <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">result6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/HRB.html">HRB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, second.moment <span class="op">=</span> <span class="cn">FALSE</span>, third.moment <span class="op">=</span> <span class="cn">FALSE</span>, interact <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># estimating ATE</span>
<span class="va">result1</span><span class="op">$</span><span class="va">AT</span> <span class="op">-</span> <span class="va">result2</span><span class="op">$</span><span class="va">AT</span> <span class="co"># produce an estimate of ATE using the Mahalanobis balancing method</span>
<span class="co">#&gt;             [,1]</span>
<span class="co">#&gt; [1,] -0.09062922</span>
<span class="va">result3</span><span class="op">$</span><span class="va">AT</span> <span class="op">-</span> <span class="va">result4</span><span class="op">$</span><span class="va">AT</span> <span class="co"># produce an estimate of ATE using the Univariate Balancing method</span>
<span class="co">#&gt;            [,1]</span>
<span class="co">#&gt; [1,] -0.3050739</span>
<span class="va">result5</span><span class="op">$</span><span class="va">AT</span> <span class="op">-</span> <span class="va">result6</span><span class="op">$</span><span class="va">AT</span> <span class="co"># produce an estimate of ATE using the Hierarchically Regularized Entropy Balancing method</span>
<span class="co">#&gt;           [,1]</span>
<span class="co">#&gt; [1,] -1.214015</span>

<span class="co"># parameter for propensity score (\beta_1-\beta_0)</span>
<span class="va">result1</span><span class="op">$</span><span class="va">parameter</span> <span class="op">-</span> <span class="va">result2</span><span class="op">$</span><span class="va">parameter</span> <span class="co"># produce an estimate of parameter in propensity score using the Mahalanobis balancing method</span>
<span class="co">#&gt;  [1] -1.0681070 -0.9728243 -0.9707689 -0.9682386 -0.7953339 -0.8804608</span>
<span class="co">#&gt;  [7] -1.1037095 -0.9024917 -0.6907932 -1.0139939</span>
<span class="va">result3</span><span class="op">$</span><span class="va">parameter</span> <span class="op">-</span> <span class="va">result4</span><span class="op">$</span><span class="va">parameter</span> <span class="co"># produce an estimate of parameter in propensity score using the Univariate Balancing method</span>
<span class="co">#&gt;  [1] -1.0302661 -0.9437848 -0.9260702 -0.9018889 -0.7300226 -0.8570399</span>
<span class="co">#&gt;  [7] -1.0816920 -0.8540281 -0.6279106 -0.9776652</span>
<span class="va">result5</span><span class="op">$</span><span class="va">parameter</span> <span class="op">-</span> <span class="va">result6</span><span class="op">$</span><span class="va">parameter</span> <span class="co"># produce an estimate of parameter in propensity score using the Hierarchically Regularized Entropy Balancing method</span>
<span class="co">#&gt;  [1] -0.7823737 -0.6253329 -0.6463390 -0.6396690 -0.5601523 -0.6385387</span>
<span class="co">#&gt;  [7] -0.7367610 -0.5859856 -0.4913990 -0.7211723</span>

<span class="co"># Generalized Mahalobnis Imbalance Measure</span>
<span class="va">result1</span><span class="op">$</span><span class="va">GMIM</span> <span class="op">+</span> <span class="va">result2</span><span class="op">$</span><span class="va">GMIM</span> <span class="co"># Generalized Mahalanobis Imbalance Measure for Mahalanobis balancing weights</span>
<span class="co">#&gt; [1] 3.593262e-07</span>
<span class="va">result3</span><span class="op">$</span><span class="va">GMIM</span> <span class="op">+</span> <span class="va">result4</span><span class="op">$</span><span class="va">GMIM</span> <span class="co"># Generalized Mahalanobis Imbalance Measure for Univariate Balancing weights</span>
<span class="co">#&gt; [1] 0.01338146</span>
<span class="va">result5</span><span class="op">$</span><span class="va">GMIM</span> <span class="op">+</span> <span class="va">result6</span><span class="op">$</span><span class="va">GMIM</span> <span class="co"># Generalized Mahalanobis Imbalance Measure for Hierarchically Regularized Entropy Balancing weights</span>
<span class="co">#&gt; [1] 0.08557126</span></code></pre></div>
<p>In function <code>si.data</code>, we generate the treatment
assignment from the logistic regression model: <span class="math inline">\(Pr(T = 1 | X) = 1/ (1 + \exp(X_1 + ... +
X_{10}))\)</span>. The ratio <span class="math inline">\(Pr(T = 1 | X) /
Pr(T = 0 | X) \text{ is } \exp(- X_1 - ... - X_{10})\)</span>.
Similarly, Mahalanobis balancing assume the propensity score model is
<span class="math inline">\(Pr(T = a | X) =
\exp(\beta_a^{\top}X)\)</span>, then the ratio is <span class="math inline">\(Pr(T = 1 | X) / Pr(T = 0 | X) will be
\exp((\beta_1-\beta_0)^{\top}X)\)</span>. If you want to learn more
about the interpretation of parameter, please see <span class="citation">Zhao (2019)</span> for more details. In simulation, our
result
<code>result1$parameter - result2$parameter = (-1.07,-0.97,-0.97,-0.97,-0.80,-0.880,-1.10, -0.902,-0.69,-1.01)</code>,
<code>result3$parameter - result4$parameter = (-1.03,-0.94,-0.93,-0.90,-0.73,-0.86,-1.08,-0.85,-0.63,-0.98)</code>
and
<code>result5$parameter - result6$parameter = (-0.78,-0.63,-0.65,-0.64,-0.56,-0.64,-0.74,-0.59,-0.49,-0.72)</code>
approximate to the true value <span class="math inline">\(-(1,1,1,1,1,1,1,1,1,1,1,1)\)</span>.</p>
</div>
<div class="section level2">
<h2 id="balancing-covariate-in-finite-sample">Balancing Covariate in Finite Sample<a class="anchor" aria-label="anchor" href="#balancing-covariate-in-finite-sample"></a>
</h2>
<p>We discuss our method in “Bad Overlap” setting. We generate treatment
indicator <span class="math inline">\(T\)</span> from <span class="math inline">\(Bernoulli(0.5)\)</span> for each observation. The
observed covariates depend on treatment assignment. If <span class="math inline">\(T = 1\)</span>, then <span class="math inline">\(X
\sim N(2, \Sigma)\)</span> where the jth row and kth column of <span class="math inline">\(\Sigma\)</span> is <span class="math inline">\(\rho^{|j−k|}\)</span> and we set <span class="math inline">\(\rho = 1/2\)</span>, otherwise, <span class="math inline">\(X \sim N(0,I)\)</span>. The observed outcome is
generated from: <span class="math inline">\(Y(T) = (1 - T)(X_1 + ... +
X_{10}) + T(X_1 + ... + X_{10}) / 2\)</span>. In this setting, <span class="math inline">\(E\{ X \mid T = 1\}\)</span> and <span class="math inline">\(E\{ X \mid T = 0\}\)</span> are significantly
different and thus it’s a very “Bad Overlap” situation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">si.data.imbal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sample.size</span> <span class="op">=</span> <span class="fl">500</span>, <span class="va">dimension</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">covmatrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span>, <span class="va">dimension</span><span class="op">)</span>
  <span class="va">treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">sample.size</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>
  <span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">sample.size</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span>
  <span class="va">z0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">sample.size</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">treat</span> <span class="op">*</span> <span class="va">z1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="va">z0</span>
  <span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">sample.size</span><span class="op">)</span>
  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">+</span> <span class="va">noise</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">treat</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># sample.size = 500</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1999</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">si.data.imbal</span><span class="op">(</span>sample.size <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt; [1] 0.2601674</span>
<span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt; [1] 1.701903</span>

<span class="co"># sample.size = 5000</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">si.data.imbal</span><span class="op">(</span>sample.size <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span>
<span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt; [1] 0.003029487</span>
<span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt; [1] 0.03736832</span>

<span class="co"># sample.size = 50000</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">si.data.imbal</span><span class="op">(</span>sample.size <span class="op">=</span> <span class="fl">50000</span><span class="op">)</span>
<span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt; [1] 1.795213e-07</span>
<span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">treat</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span><span class="op">)</span><span class="op">$</span><span class="va">GMIM</span>
<span class="co">#&gt; [1] 1.298165e-07</span></code></pre></div>
<p>When the sample size = 500, we find that GMIM is quite large, and
thus we recommend using something other than the MB method to estimate
the average treatment effect. MB method may not approximately balance
covariates in the finite sample in very `` Bad Overlap” setting.
However, when the sample size = 5000, we find that GMIM is relatively
small. Therefore, we can use the result produced by the MB method. When
the GMIM is relatively small, we recommend using the MB method to
estimate the average treatment effect. Our method can handle some `` Bad
Overlap” settings. However, it cannot solve the situation when it’s
extreme ``Bad Overlap” in a finite sample. GMIM is a balancing measure
to judge whether our approach can approximately balance covariates.</p>
</div>
<div class="section level2">
<h2 id="computational-efficiency">Computational efficiency<a class="anchor" aria-label="anchor" href="#computational-efficiency"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0521</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/si.data.html">si.data</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span>, treat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Y</span>, method <span class="op">=</span> <span class="st">"MB"</span>, opti.method <span class="op">=</span> <span class="st">"proximal"</span><span class="op">)</span>,
  times <span class="op">=</span> <span class="fl">10</span>
<span class="op">)</span>
<span class="co">#&gt; Warning in microbenchmark::microbenchmark(MB(covariate = data$X, treat =</span>
<span class="co">#&gt; data$Tr, : less accurate nanosecond times to avoid potential integer overflows</span>
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;                                                                                                                  expr</span>
<span class="co">#&gt;  MB(covariate = data$X, treat = data$Tr, group1 = 1, outcome = data$Y,      method = "MB", opti.method = "proximalC")</span>
<span class="co">#&gt;   MB(covariate = data$X, treat = data$Tr, group1 = 1, outcome = data$Y,      method = "MB", opti.method = "proximal")</span>
<span class="co">#&gt;       min       lq     mean   median       uq       max neval</span>
<span class="co">#&gt;  3.418088 3.449002 3.467858 3.463885 3.481638  3.545721    10</span>
<span class="co">#&gt;  7.139207 7.279550 7.878769 7.492176 7.589428 12.003980    10</span></code></pre></div>
<p>We can find that our C++ code highly improves computational
efficiency.</p>
</div>
<div class="section level2">
<h2 id="implementation-of-other-covariate-balancing-methods">Implementation of other covariate balancing methods<a class="anchor" aria-label="anchor" href="#implementation-of-other-covariate-balancing-methods"></a>
</h2>
<p>We provide function <code>covbal</code> (using R package
<code>Weightit</code> <span class="citation">Greifer (2022)</span>) to
implement Mahalanobis balancing method and other covariate balancing
methods, including inverse probability weighting (ps) in <span class="citation">Rosenbaum (1987)</span>, entropy balancing (ebal) in
<span class="citation">Hainmueller (2012)</span>, covariate balancing
propensity score (cbps) in <span class="citation">Imai and Ratkovic
(2014)</span>, energy balancing (energy) in <span class="citation">Huling and Mak (2020)</span>, minimal dispersion
approximate balancing weights (UB) in <span class="citation">Wang and
Zubizarreta (2020)</span>, kernel-based covariate balancing (kernel) in
<span class="citation">Wong and Chan (2018)</span> and hierarchically
regularized entropy balancing (HRB) in <span class="citation">Xu and
Yang (2021)</span>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/WeightIt/" class="external-link">WeightIt</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ATE.ncb</span><span class="op">)</span>
<span class="va">covbal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">Tr</span>, <span class="va">Y</span>, <span class="va">MB.only</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Tr</span><span class="op">)</span><span class="op">)</span>
  <span class="va">sample.size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="va">dimension</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>

  <span class="va">ps.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="va">ps.ate</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="va">ebal.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="va">ebal.ate</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="va">cbps.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="va">cbps.ate</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="va">energy.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="va">energy.ate</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="va">kernel.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="va">kernel.ate</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="va">HRB.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="va">HRB.ate</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="va">UB.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="va">UB.ate</span> <span class="op">&lt;-</span> <span class="cn">NA</span>

  <span class="kw">if</span> <span class="op">(</span><span class="va">MB.only</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">character</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data.matrix</span><span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">character</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">myformula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="fl">1</span> <span class="op">+</span> <span class="va">dimension</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">" ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

    <span class="va">ps.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="va">sample.size</span><span class="op">)</span>
    <span class="va">ps.ate</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
    <span class="va">ps.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span><span class="va">myformula</span>, data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, method <span class="op">=</span> <span class="st">"ps"</span><span class="op">)</span><span class="op">$</span><span class="va">weights</span>
    <span class="va">ps.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">ps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">ps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>

    <span class="va">ebal.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span><span class="va">myformula</span>, data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, method <span class="op">=</span> <span class="st">"ebal"</span><span class="op">)</span><span class="op">$</span><span class="va">weights</span>
    <span class="va">ebal.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">ebal.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ebal.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">ebal.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ebal.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>
    <span class="va">ebal.weight</span><span class="op">[</span><span class="va">ebal.weight</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>

    <span class="va">cbps.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span><span class="va">myformula</span>, data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, method <span class="op">=</span> <span class="st">"cbps"</span>, over <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">weights</span>
    <span class="va">cbps.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cbps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cbps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cbps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">cbps.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>

    <span class="va">energy.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span><span class="va">myformula</span>, data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, method <span class="op">=</span> <span class="st">"energy"</span><span class="op">)</span><span class="op">$</span><span class="va">weights</span>
    <span class="va">energy.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">energy.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">energy.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">energy.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">energy.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>

    <span class="co"># Sobolev kernel</span>
    <span class="va">Xstd</span> <span class="op">&lt;-</span> <span class="fu">transform.sob</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">$</span><span class="va">Xstd</span> <span class="co"># standardize X to [0,1]^p</span>
    <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu">getGram</span><span class="op">(</span><span class="va">Xstd</span><span class="op">)</span> <span class="co"># get Gram matrix using Sobolev kernel</span>
    <span class="va">nlam</span> <span class="op">&lt;-</span> <span class="fl">20</span>
    <span class="va">lams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1e-8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, len <span class="op">=</span> <span class="va">nlam</span><span class="op">)</span><span class="op">)</span>

    <span class="co"># compute weights for T=1 / T=0</span>
    <span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ATE.ncb/man/ATE.ncb.SN.html" class="external-link">ATE.ncb.SN</a></span><span class="op">(</span><span class="va">Tr</span>, <span class="va">K</span>, lam1s <span class="op">=</span> <span class="va">lams</span>, traceit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">$</span><span class="va">warns</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"lambda bound warning!\n"</span><span class="op">)</span>
    <span class="va">fit0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ATE.ncb/man/ATE.ncb.SN.html" class="external-link">ATE.ncb.SN</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">Tr</span>, <span class="va">K</span>, lam1s <span class="op">=</span> <span class="va">lams</span>, traceit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">fit0</span><span class="op">$</span><span class="va">warns</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"lambda bound warning!\n"</span><span class="op">)</span>
    <span class="va">kernel.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">$</span><span class="va">w</span> <span class="op">*</span> <span class="va">Y</span> <span class="op">-</span> <span class="va">fit0</span><span class="op">$</span><span class="va">w</span> <span class="op">*</span> <span class="va">Y</span><span class="op">)</span>
    <span class="va">kernel.weight</span> <span class="op">&lt;-</span> <span class="va">fit1</span><span class="op">$</span><span class="va">w</span>
    <span class="va">kernel.weight</span> <span class="op">&lt;-</span> <span class="va">kernel.weight</span> <span class="op">+</span> <span class="va">fit0</span><span class="op">$</span><span class="va">w</span>
    
    <span class="va">UB.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
    <span class="va">UB1.result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/UB.html">UB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">Y</span>, opti.method <span class="op">=</span> <span class="st">"proximal"</span><span class="op">)</span>
    <span class="va">UB2.result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/UB.html">UB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">Y</span>, opti.method <span class="op">=</span> <span class="st">"proximal"</span><span class="op">)</span>
    <span class="va">UB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="va">UB1.result</span><span class="op">$</span><span class="va">weight</span>
    <span class="va">UB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">UB2.result</span><span class="op">$</span><span class="va">weight</span>
    <span class="va">UB.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">UB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">UB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">UB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">UB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>

    <span class="va">HRB1.result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/HRB.html">HRB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="va">Y</span><span class="op">)</span>
    <span class="va">HRB2.result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/HRB.html">HRB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="va">Y</span><span class="op">)</span>
    <span class="va">HRB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="va">HRB1.result</span><span class="op">$</span><span class="va">weight</span>
    <span class="va">HRB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">HRB2.result</span><span class="op">$</span><span class="va">weight</span>
    <span class="va">HRB.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">HRB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">HRB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">HRB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">HRB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>
  <span class="op">}</span>

  <span class="va">MB.weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="va">MB1.result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">0</span>, outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">sample.size</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"MB"</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span>, rate <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
  <span class="va">MB2.result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MB.html">MB</a></span><span class="op">(</span>covariate <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">Tr</span>, group1 <span class="op">=</span> <span class="fl">1</span>, outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">sample.size</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"MB"</span>, opti.method <span class="op">=</span> <span class="st">"proximalC"</span>, rate <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
  <span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="va">MB1.result</span><span class="op">$</span><span class="va">weight</span>
  <span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">MB2.result</span><span class="op">$</span><span class="va">weight</span>
  <span class="va">MB.ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">MB.weight</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Y</span><span class="op">[</span><span class="va">Tr</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="va">ps.weight</span>, ebal <span class="op">=</span> <span class="va">ebal.weight</span>, cbps <span class="op">=</span> <span class="va">cbps.weight</span>, energy <span class="op">=</span> <span class="va">energy.weight</span>, MB <span class="op">=</span> <span class="va">MB.weight</span>, UB <span class="op">=</span> <span class="va">UB.weight</span>, HRB <span class="op">=</span> <span class="va">HRB.weight</span>, kernel <span class="op">=</span> <span class="va">kernel.weight</span><span class="op">)</span>, ate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="va">ps.ate</span>, ebal <span class="op">=</span> <span class="va">ebal.ate</span>, cbps <span class="op">=</span> <span class="va">cbps.ate</span>, energy <span class="op">=</span> <span class="va">energy.ate</span>, MB <span class="op">=</span> <span class="va">MB.ate</span>, UB <span class="op">=</span> <span class="va">UB.ate</span>, HRB <span class="op">=</span> <span class="va">HRB.ate</span>, kernel <span class="op">=</span> <span class="va">kernel.ate</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="evaluation-of-covariate-balance-using-asmd">Evaluation of Covariate Balance using ASMD<a class="anchor" aria-label="anchor" href="#evaluation-of-covariate-balance-using-asmd"></a>
</h2>
<p>Absolute Standardized Mean Difference (ASMD) is causal inference’s
most common balancing measure. ASMD is calculated as the difference in
means of a covariate across the treatment groups divided by the standard
deviation in the treated and control groups. ASMD that less than 0.1 or
0.25 represent reasonable cut-offs for acceptable standardized biases.
In our method, we recommend using GMIM to evaluate covariate balance.
The difference between GMIM and ASMD is that small GMIM can also imply
small ASMD; conversely, this is not true. Moreover, GMIM can evaluate
the doubly robust property for the weighting estimator, while ASMD
cannot. For more details, please check our paper <a href="https://arxiv.org/abs/2204.13439" class="external-link">Mahalanobis balancing: a
multivariate perspective on approximate covariate balancing</a>. The
code below shows that our method (MB) can guarantee ASMD of less than
0.1 in simulation.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot ASMD</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/cobalt/" class="external-link">cobalt</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1999</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/si.data.html">si.data</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">dimension</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="va">data.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Tr</span><span class="op">)</span><span class="op">)</span>
<span class="va">character</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data.matrix</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">character</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">myformula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="fl">1</span> <span class="op">+</span> <span class="va">dimension</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">" ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">character</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">covbal</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, <span class="va">data</span><span class="op">$</span><span class="va">Tr</span>, <span class="va">data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span>
<span class="va">plot.ASMD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/love.plot.html" class="external-link">love.plot</a></span><span class="op">(</span><span class="va">myformula</span>,
  data <span class="op">=</span> <span class="va">data.matrix</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>,
  stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mean.diffs"</span><span class="op">)</span>,
  weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    w1 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">MB</span>,
    w2 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">ps</span>,
    w3 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">ebal</span>,
    w4 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">cbps</span>,
    w5 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">energy</span>,
    w6 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">UB</span>,
    w7 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">HRB</span>,
    w8 <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">weight</span><span class="op">$</span><span class="va">kernel</span>
  <span class="op">)</span>,
  var.order <span class="op">=</span> <span class="st">"unadjusted"</span>,
  abs <span class="op">=</span> <span class="cn">TRUE</span>,
  line <span class="op">=</span> <span class="cn">TRUE</span>,
  thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span>,
  sample.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Unweighted"</span>, <span class="st">"MB"</span>, <span class="st">"PS"</span>, <span class="st">"ebal"</span>, <span class="st">"cbps"</span>, <span class="st">"energy"</span>, <span class="st">"UB"</span>, <span class="st">"HRB"</span>, <span class="st">"kernel"</span><span class="op">)</span>,
  limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span>,
  wrap <span class="op">=</span> <span class="fl">20</span>,
  position <span class="op">=</span> <span class="st">"top"</span>
<span class="op">)</span>
<span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span>
<span class="va">plot.ASMD</span></code></pre></div>
<p><img src="package_intro_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="replication-of-simulation">Replication of Simulation<a class="anchor" aria-label="anchor" href="#replication-of-simulation"></a>
</h2>
<p>We consider four different simulation settings.</p>
<p>The first simulation will be Scenario A in our paper.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">si.data.Wong.Chan</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dimension</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">sample.size</span> <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">sample.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">sample.size</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="fl">4</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sample.size</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="fl">1</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.6</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fl">20</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="fl">5</span><span class="op">:</span><span class="va">dimension</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">z</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="va">dimension</span><span class="op">]</span>
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">p</span><span class="op">)</span>
    <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">210</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1.5</span> <span class="op">*</span> <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">temp</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">210</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">210</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">13.7</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">sample.matrix</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">]</span>, treat <span class="op">=</span> <span class="va">sample.matrix</span><span class="op">[</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>, Y <span class="op">=</span> <span class="va">sample.matrix</span><span class="op">[</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The second simulation will be Scenario B in our paper. The confounder
will be the interaction of <span class="math inline">\(X_i\)</span> and
<span class="math inline">\(X_j\)</span> but not <span class="math inline">\(X_i\)</span>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">si.data.interaction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dimension</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">sample.size</span> <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">sample.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">sample.size</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
  <span class="va">covariance.matrix.A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span>, <span class="va">dimension</span><span class="op">)</span>
  <span class="va">covariance.matrix.B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span>, <span class="va">dimension</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">covariance.matrix.A</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">^</span><span class="op">{</span>
        <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">i</span> <span class="op">!=</span> <span class="va">j</span><span class="op">)</span>
      <span class="op">}</span>
    <span class="op">}</span>
  <span class="op">}</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">covariance.matrix.B</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
    <span class="op">}</span>
  <span class="op">}</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sample.size</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>
    <span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="fl">1</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="va">covariance.matrix.A</span><span class="op">)</span>
    <span class="va">z0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="fl">1</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">p</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">z</span> <span class="op">&lt;-</span> <span class="va">z1</span>
    <span class="op">}</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">p</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">z</span> <span class="op">&lt;-</span> <span class="va">z0</span>
    <span class="op">}</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">z</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">f</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">dimension</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">f</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="op">(</span><span class="va">f</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">z</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="va">f</span><span class="op">]</span>
      <span class="op">}</span>
    <span class="op">}</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span>
    <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">*</span> <span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
    <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">*</span> <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span> <span class="op">*</span> <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="va">temp</span>
  <span class="op">}</span>
  <span class="va">true_Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="op">-</span> <span class="va">sample.matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">sample.matrix</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">]</span>, treat <span class="op">=</span> <span class="va">sample.matrix</span><span class="op">[</span>, <span class="va">dimension</span> <span class="op">+</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span>, Y <span class="op">=</span> <span class="va">sample.matrix</span><span class="op">[</span>, <span class="va">dimension</span> <span class="op">*</span> <span class="op">(</span><span class="va">dimension</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">2</span><span class="op">]</span>, true_Y <span class="op">=</span> <span class="va">true_Y</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The third simulation will be Scenario C in our paper. We first
generate treatment indicator <span class="math inline">\(T\)</span> from
<span class="math inline">\(Bernoulli(0.5)\)</span> for each
observation. The observed covariates depend on treatment assignment. If
<span class="math inline">\(T = 1\)</span>, then <span class="math inline">\(X \sim N(1, \Sigma)\)</span> where the jth row and
kth column of <span class="math inline">\(\Sigma\)</span> is <span class="math inline">\(\rho^{|j−k|}\)</span> and we set <span class="math inline">\(\rho = 1/2\)</span>, otherwise, <span class="math inline">\(X \sim N(0,I)\)</span>. The observed outcome is
generated from: <span class="math inline">\(Y(T) = (1 - T)(X_1 + ... +
X_6) + T(X_1 + ... + X_6) / 2\)</span>. In this setting, <span class="math inline">\(E\{ X \mid T = 1\}\)</span> and <span class="math inline">\(E\{ X \mid T = 0\}\)</span> are significantly
different and thus it’s a “Bad Overlap” situation.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">si.data.extreme.mean.diff</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dimension</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">sample.size</span> <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">covmatrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span>, <span class="va">dimension</span><span class="op">)</span>
  <span class="va">treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">sample.size</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>
  <span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">sample.size</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span>
  <span class="va">z0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">sample.size</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">dimension</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">treat</span> <span class="op">*</span> <span class="va">z1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="va">z0</span>
  <span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample.size</span><span class="op">)</span>
  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">+</span> <span class="va">noise</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">treat</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The fourth simulation setting corresponds Scenario D to our paper.
The observed covariates are simulated by <span class="math inline">\(X
\sim N(1,I)\)</span>. The treatment indicator is simulated from <span class="math inline">\(T ∼ Bernoulli(\pi(X))\)</span> with <span class="math inline">\(π(X) = 1/(1+19 \exp(X_1+···+X_{10}−10))\)</span>.
The outcome is simulated from <span class="math inline">\(Y =
(1+T)(X_1+···+X_{10}) + \epsilon\)</span>, where <span class="math inline">\(\epsilon \sim N(0,1)\)</span>. In this setting,
<span class="math inline">\(E\{Pr(T = 1 \mid X)\}\)</span> closes to 0
or 1 and thus it’s a “Bad Overlap” situation.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">si.data.extreme_sample_size</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dimension</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">sample.size</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample.size</span> <span class="op">*</span> <span class="va">dimension</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, nrow <span class="op">=</span> <span class="va">sample.size</span>, ncol <span class="op">=</span> <span class="va">dimension</span><span class="op">)</span>
  <span class="va">ps</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">19</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
  <span class="va">treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">sample.size</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sample.size</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">treat</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">ps</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">sample.size</span><span class="op">)</span>
  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">treat</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">+</span> <span class="va">noise</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, treat <span class="op">=</span> <span class="va">treat</span>, Y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We repeat 1 time. If you want to simulate more times, please modify
<code>mainf1(1)</code> to <code>mainf1(200)</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mainf1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">iteration</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">result1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">iteration</span>, <span class="fl">8</span><span class="op">)</span>
  <span class="va">result2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">iteration</span>, <span class="fl">8</span><span class="op">)</span>
  <span class="va">result3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">iteration</span>, <span class="fl">8</span><span class="op">)</span>
  <span class="va">result4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">iteration</span>, <span class="fl">8</span><span class="op">)</span>
  <span class="va">data2Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">iteration</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">iteration</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">data1</span> <span class="op">&lt;-</span> <span class="fu">si.data.Wong.Chan</span><span class="op">(</span><span class="op">)</span>
    <span class="va">data2</span> <span class="op">&lt;-</span> <span class="fu">si.data.interaction</span><span class="op">(</span><span class="op">)</span>
    <span class="va">data3</span> <span class="op">&lt;-</span> <span class="fu">si.data.extreme.mean.diff</span><span class="op">(</span><span class="op">)</span>
    <span class="va">data4</span> <span class="op">&lt;-</span> <span class="fu">si.data.extreme_sample_size</span><span class="op">(</span><span class="op">)</span>
    <span class="va">result1</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">covbal</span><span class="op">(</span><span class="va">data1</span><span class="op">$</span><span class="va">X</span>, <span class="va">data1</span><span class="op">$</span><span class="va">treat</span>, <span class="va">data1</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">$</span><span class="va">ate</span>
    <span class="va">result2</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">covbal</span><span class="op">(</span><span class="va">data2</span><span class="op">$</span><span class="va">X</span>, <span class="va">data2</span><span class="op">$</span><span class="va">treat</span>, <span class="va">data2</span><span class="op">$</span><span class="va">Y</span>, MB.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">ate</span>
    <span class="va">result3</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">covbal</span><span class="op">(</span><span class="va">data3</span><span class="op">$</span><span class="va">X</span>, <span class="va">data3</span><span class="op">$</span><span class="va">treat</span>, <span class="va">data3</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">$</span><span class="va">ate</span>
    <span class="va">result4</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">covbal</span><span class="op">(</span><span class="va">data4</span><span class="op">$</span><span class="va">X</span>, <span class="va">data4</span><span class="op">$</span><span class="va">treat</span>, <span class="va">data4</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">$</span><span class="va">ate</span>
    <span class="va">data2Y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">data2</span><span class="op">$</span><span class="va">true_Y</span>
  <span class="op">}</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Wong.Chan.bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">result1</span><span class="op">)</span>, si.data.interaction.bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">result2</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data2Y</span><span class="op">)</span>, extreme.mean.diff.bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">result3</span><span class="op">)</span> <span class="op">-</span> <span class="fl">5</span>, extreme_sample_size.bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">result4</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1124</span><span class="op">)</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">mainf1</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>

<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>wong.chan <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">Wong.Chan.bias</span>, interaction <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">si.data.interaction.bias</span>, extreme.mean <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">extreme.mean.diff.bias</span>, extreme_sample_size <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">extreme_sample_size.bias</span>, method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ps"</span>, <span class="st">"ebal"</span>, <span class="st">"CBPS"</span>, <span class="st">"energy"</span>, <span class="st">"MB"</span>, <span class="st">"UB"</span>, <span class="st">"HRB"</span>, <span class="st">"kernel"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">method</span>, y <span class="op">=</span> <span class="va">wong.chan</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"bias"</span>, x <span class="op">=</span> <span class="st">"method"</span>, title <span class="op">=</span> <span class="st">"wong chan simulation result"</span><span class="op">)</span></code></pre></div>
<p><img src="package_intro_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">method</span>, y <span class="op">=</span> <span class="va">interaction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"bias"</span>, x <span class="op">=</span> <span class="st">"method"</span>, title <span class="op">=</span> <span class="st">"interaction simulation result"</span><span class="op">)</span></code></pre></div>
<p><img src="package_intro_files/figure-html/unnamed-chunk-12-2.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">method</span>, y <span class="op">=</span> <span class="va">extreme.mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"bias"</span>, x <span class="op">=</span> <span class="st">"method"</span>, title <span class="op">=</span> <span class="st">"extreme.mean.diff.bias simulation result"</span><span class="op">)</span></code></pre></div>
<p><img src="package_intro_files/figure-html/unnamed-chunk-12-3.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">method</span>, y <span class="op">=</span> <span class="va">extreme_sample_size</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"bias"</span>, x <span class="op">=</span> <span class="st">"method"</span>, title <span class="op">=</span> <span class="st">"extreme_sample_size simulation result"</span><span class="op">)</span></code></pre></div>
<p><img src="package_intro_files/figure-html/unnamed-chunk-12-4.png" width="700"></p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Gerifer2022Weightit" class="csl-entry">
Greifer, Noah. 2022. <em>WeightIt: Weighting for Covariate Balance in
Observational Studies</em>.
</div>
<div id="ref-hainmueller2012entropy" class="csl-entry">
Hainmueller, Jens. 2012. <span>“Entropy Balancing for Causal Effects: A
Multivariate Reweighting Method to Produce Balanced Samples in
Observational Studies.”</span> <em>Political Analysis</em> 20 (1):
25–46.
</div>
<div id="ref-huling2020energy" class="csl-entry">
Huling, Jared D, and Simon Mak. 2020. <span>“Energy Balancing of
Covariate Distributions.”</span> <em>arXiv Preprint
arXiv:2004.13962</em>.
</div>
<div id="ref-imai2014covariate" class="csl-entry">
Imai, Kosuke, and Marc Ratkovic. 2014. <span>“Covariate Balancing
Propensity Score.”</span> <em>Journal of the Royal Statistical Society:
Series B (Statistical Methodology)</em> 76 (1): 243–63.
</div>
<div id="ref-imbens2015causal" class="csl-entry">
Imbens, Guido W, and Donald B Rubin. 2015. <em>Causal Inference in
Statistics, Social, and Biomedical Sciences</em>. Cambridge University
Press.
</div>
<div id="ref-rosenbaum1987model" class="csl-entry">
Rosenbaum, Paul R. 1987. <span>“Model-Based Direct Adjustment.”</span>
<em>Journal of the American Statistical Association</em> 82 (398):
387–94.
</div>
<div id="ref-wang2020minimal" class="csl-entry">
Wang, Yixin, and Jose R Zubizarreta. 2020. <span>“Minimal Dispersion
Approximately Balancing Weights: Asymptotic Properties and Practical
Considerations.”</span> <em>Biometrika</em> 107 (1): 93–105.
</div>
<div id="ref-wong2018kernel" class="csl-entry">
Wong, Raymond KW, and Kwun Chuen Gary Chan. 2018. <span>“Kernel-Based
Covariate Functional Balancing for Observational Studies.”</span>
<em>Biometrika</em> 105 (1): 199–213.
</div>
<div id="ref-xu2021hierarchically" class="csl-entry">
Xu, Yiqing, and Eddie Yang. 2021. <span>“Hierarchically Regularized
Entropy Balancing.”</span> <em>Available at SSRN 3807620</em>.
</div>
<div id="ref-zhao2019covariate" class="csl-entry">
Zhao, Qingyuan. 2019. <span>“Covariate Balancing Propensity Score by
Tailored Loss Functions.”</span> <em>The Annals of Statistics</em> 47
(2): 965–93.
</div>
<div id="ref-zubizarreta2015stable" class="csl-entry">
Zubizarreta, José R. 2015. <span>“Stable Weights That Balance Covariates
for Estimation with Incomplete Outcome Data.”</span> <em>Journal of the
American Statistical Association</em> 110 (511): 910–22.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Yimin Dai.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
